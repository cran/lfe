
R Under development (unstable) (2014-12-21 r67196) -- "Unsuffered Consequences"
Copyright (C) 2014 The R Foundation for Statistical Computing
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library(lfe)
Loading required package: Matrix
> options(lfe.threads=2,digits=5,warn=1,lfe.eps=1e-5)
> set.seed(42)
> x <- rnorm(400)
> x2 <- rnorm(length(x))
> 
> id <- factor(sample(10,length(x),replace=TRUE))
> firm <- factor(sample(3,length(x),replace=TRUE,prob=c(2,1,1)))
> id.eff <- rnorm(nlevels(id))
> firm.eff <- rnorm(nlevels(firm))
> 
> ## left hand side
> u <- rnorm(length(x))
> x3 <- rnorm(length(x))
> x4 <- rnorm(length(x))
> Q <- 0.3*x3 + x + 0.2*x2 + id.eff[id] + 0.15*u + rnorm(length(x),sd=0.2)
> R <- 0.001*x3 + 0.2*x + 0.5*x2 + 0.7*id.eff[id] - 0.11*u + rnorm(length(x),sd=0.2)
> y <- x + 0.5*x2 + id.eff[id] + firm.eff[firm] + Q + R + u
> 
> ## estimate and print result
> est <- felm(y ~ x+x2 | id+firm |(Q|R~x3+x4))
> summary(est,robust=TRUE)

Call:
   felm(formula = y ~ x + x2 | id + firm | (Q | R ~ x3 + x4)) 

Residuals:
    Min      1Q  Median      3Q     Max 
-3.0408 -0.7225 -0.0161  0.7717  2.7743 

Coefficients:
         Estimate Robust s.e t value Pr(>|t|)    
x          -0.274      1.165   -0.24     0.81    
x2         -1.964      2.615   -0.75     0.45    
`Q(fit)`    1.273      0.274    4.66  4.5e-06 ***
`R(fit)`    5.881      5.274    1.12     0.27    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.77 on 384 degrees of freedom
Multiple R-squared: 0.818   Adjusted R-squared: 0.81 
F-statistic(normal s.e.): 131 on 15 and 384 DF, p-value: <2e-16 
F-statistic(proj): 49.1 on 15 and 384 DF, p-value: <2e-16 
*** F-test for robust/clustered standard errors is unreliable


> clu <- factor(sample(10,length(x), replace=TRUE))
> # try it from a function
> fun <- function() {
+   Y <- y
+   S <- Q
+   felm(Y ~ x+x2 | id + firm |(S|R ~ x3+x4), cluster=clu)
+   fr <- data.frame(y,x,x2,id,firm,Q,R,x3,x4)
+   felm(y ~ x+x2 | id + firm |(Q|R ~ x3+x4), data=fr, cluster=clu)
+ }
> est <- fun()
> summary(est, robust=TRUE)

Call:
   felm(formula = y ~ x + x2 | id + firm | (Q | R ~ x3 + x4), data = fr,      clustervar = clu) 

Residuals:
    Min      1Q  Median      3Q     Max 
-3.0408 -0.7225 -0.0161  0.7717  2.7743 

Coefficients:
         Estimate Cluster s.e. t value Pr(>|t|)    
x          -0.274        1.455   -0.19     0.85    
x2         -1.964        3.037   -0.65     0.52    
`Q(fit)`    1.273        0.318    4.00  7.6e-05 ***
`R(fit)`    5.881        5.997    0.98     0.33    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.77 on 384 degrees of freedom
Multiple R-squared: 0.818   Adjusted R-squared: 0.81 
F-statistic(normal s.e.): 131 on 15 and 384 DF, p-value: <2e-16 
F-statistic(proj):  118 on 15 and 384 DF, p-value: <2e-16 
*** F-test for robust/clustered standard errors is unreliable


> for(s1 in est$step1) print(summary(s1))

Call:
   felm(formula = Q ~ x + x2 + (x3 + x4) | id + firm + 0, data = fr,      clustervar = clu) 

Residuals:
    Min      1Q  Median      3Q     Max 
-0.7738 -0.1703  0.0109  0.1804  0.7101 

Coefficients:
    Estimate Cluster s.e. t value Pr(>|t|)    
x   1.016396     0.012886   78.87   <2e-16 ***
x2  0.201962     0.010641   18.98   <2e-16 ***
x3  0.321484     0.014920   21.55   <2e-16 ***
x4 -0.000384     0.012235   -0.03     0.97    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.261 on 384 degrees of freedom
Multiple R-squared: 0.971   Adjusted R-squared: 0.97 
F-statistic(normal s.e.): 856 on 15 and 384 DF, p-value: <2e-16 
F-statistic(proj):  622 on 15 and 384 DF, p-value: <2e-16 
F-stat (excl i.v. n.s.e): 291 on 2 and 384 DF, p-value: <2e-16 
F-stat (excl i.v. proj):  590 on 2 and 384 DF, p-value: <2e-16 
*** F-test for excluded instruments assumes constant absorbed effects
*** F-test for robust/clustered standard errors is unreliable



Call:
   felm(formula = R ~ x + x2 + (x3 + x4) | id + firm + 0, data = fr,      clustervar = clu) 

Residuals:
     Min       1Q   Median       3Q      Max 
-0.68319 -0.14386 -0.00862  0.14153  0.66717 

Coefficients:
    Estimate Cluster s.e. t value Pr(>|t|)    
x   0.210119     0.012505   16.80   <2e-16 ***
x2  0.495201     0.012567   39.41   <2e-16 ***
x3 -0.000712     0.012345   -0.06     0.95    
x4 -0.015781     0.014154   -1.11     0.27    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.231 on 384 degrees of freedom
Multiple R-squared: 0.942   Adjusted R-squared: 0.939 
F-statistic(normal s.e.): 415 on 15 and 384 DF, p-value: <2e-16 
F-statistic(proj):  124 on 15 and 384 DF, p-value: <2e-16 
F-stat (excl i.v. n.s.e):0.913 on 2 and 384 DF, p-value: 0.402 
F-stat (excl i.v. proj): 1.61 on 2 and 384 DF, p-value: 0.201 
*** F-test for excluded instruments assumes constant absorbed effects
*** F-test for robust/clustered standard errors is unreliable


> 
> proc.time()
   user  system elapsed 
 15.724   0.356  15.724 
